name: AutoFlow - Classify Issue

on:
  issues:
    types: [opened, labeled, unlabeled]

permissions:
  issues: write
  contents: read

jobs:
  classify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Get issue data
        id: issue-data
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issueData = {
              number: issue.number,
              title: issue.title,
              body: issue.body || '',
              labels: issue.labels,
              user: issue.user,
              created_at: issue.created_at
            };
            core.setOutput('data', JSON.stringify(issueData));

      - name: Classify issue
        id: classify
        run: |
          cd scarecrow_autoflow/scripts
          RESULT=$(python classificador.py --type issue --number ${{ github.event.issue.number }} --data '${{ steps.issue-data.outputs.data }}')
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Extract category
        id: category
        uses: actions/github-script@v7
        with:
          script: |
            const result = JSON.parse(`${{ steps.classify.outputs.result }}`);
            core.setOutput('category', result.category);
            core.setOutput('confidence', result.confidence);
            core.setOutput('justificativa', result.justificativa);

      - name: Add label
        uses: actions/github-script@v7
        with:
          script: |
            const category = '${{ steps.category.outputs.category }}';
            const confidence = '${{ steps.category.outputs.confidence }}';
            const justificativa = `${{ steps.category.outputs.justificativa }}`;
            
            // Remove old autoflow labels
            const oldLabels = ['autoflow:auto-merge', 'autoflow:needs-simulation', 'autoflow:manual-review'];
            for (const label of oldLabels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (error) {
                // Label might not exist, ignore
              }
            }
            
            // Add new label
            if (category !== 'skip') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [`autoflow:${category}`]
              });
            }
            
            // Add comment
            const comment = `## ðŸ¤– Scarecrow AutoFlow - ClassificaÃ§Ã£o AutomÃ¡tica

**Categoria:** \`${category}\`  
**ConfianÃ§a:** ${confidence}%  
**Justificativa:** ${justificativa}

---

${category === 'auto-merge' ? 'âœ… Esta issue foi classificada para **aprovaÃ§Ã£o automÃ¡tica**. ValidaÃ§Ã£o de conformidade serÃ¡ executada.' : ''}
${category === 'needs-simulation' ? 'ðŸ”„ Esta issue foi classificada para **simulaÃ§Ã£o de decisÃ£o**. Um debate entre personas serÃ¡ realizado.' : ''}
${category === 'manual-review' ? 'ðŸ‘¤ Esta issue foi classificada para **revisÃ£o manual**. Um mantenedor humano deverÃ¡ avaliÃ¡-la.' : ''}
${category === 'skip' ? 'â­ï¸ Esta issue serÃ¡ **ignorada** pelo sistema de automaÃ§Ã£o.' : ''}

*ClassificaÃ§Ã£o automÃ¡tica v1.0 - Scarecrow AutoFlow*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Create decision log
        run: |
          DATE=$(date +%Y-%m-%d)
          MONTH=$(date +%Y-%m)
          CATEGORY="${{ steps.category.outputs.category }}"
          mkdir -p "scarecrow_autoflow/decisoes_automatizadas/$MONTH"
          
          cat > "scarecrow_autoflow/decisoes_automatizadas/$MONTH/${DATE}_classification_issue-${{ github.event.issue.number }}_${CATEGORY}.md" << 'EOF'
          # Log de ClassificaÃ§Ã£o â€” ${{ github.event.issue.title }}

          **Issue:** #${{ github.event.issue.number }}  
          **Tipo:** Issue  
          **Data:** $(date -u +%Y-%m-%dT%H:%M:%SZ)  
          **VersÃ£o do Sistema:** 1.0

          ---

          ## Resultado da ClassificaÃ§Ã£o

          ```json
          ${{ steps.classify.outputs.result }}
          ```

          ---

          **Link:** ${{ github.event.issue.html_url }}  
          **Log gerado por:** Scarecrow AutoFlow v1.0
          EOF

      - name: Commit log
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "autoflow: Log de classificaÃ§Ã£o issue #${{ github.event.issue.number }}"
          file_pattern: "scarecrow_autoflow/decisoes_automatizadas/**/*.md"
